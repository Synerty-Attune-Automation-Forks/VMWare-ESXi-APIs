
pwsh -NonInteractive -NoProfile -Command - <<'EOF'
Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"

Import-Module VMware.VimAutomation.Core

Connect-VIServer {vmwareVcenterNode.ip} `
    -User "{vmwareVcenterUser.user}" `
    -Password "{vmwareVcenterUser.password}"

if ($? -eq $false) {
    Write-Host "Error: Not connected."
    exit 1
}

$existing = $null;
$existing = Get-VM "{newVmNode.fqn}"

if ( $existing ) {
    Write-Host "We found the VM from the FQN"
} else {
    Write-Host "Getting VM by hostname"
    $existing = Get-VM "{newVmNode.hostname}"
}

$existing

if ( $existing ) {
    if ( $existing.PowerState -eq "PoweredOn" ) {
        "Stopping the VM"
        Stop-VM -VM $existing -Confirm:$false
    } else {
        "The VM is off"
    }
    
    "Removing the VM"
    Remove-VM -DeleteFromDisk -VM $existing -Confirm:$false
    
} else {
    "The VM doesn't exist"
}

EOF
