
<!doctype html>
<html lang="en">




<head>
    <title>How to Build Virtual Machine on ESXi with Windows Worker - Attune Automation</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="title"
          content="How to Build Virtual Machine on ESXi with Windows Worker - Attune Automation">
    <meta name="description"
          content="">
    <meta name="robots"
          content="follow, index, max-snippet:-1, max-video-preview:-1, max-image-preview:large">

    <meta property="og:locale" content="en_AU" />
    <meta property="og:type" content="article" />
    <meta property="og:title"
          content="HowTo Build Virtual Machine on ESXi with Windows Worker - Attune Automation" />
    <meta property="og:description" content="" />
    <meta property="og:site_name" content="Attune Automation" />
    <meta property="article:section" content="IT Instruction" />

    <meta name="twitter:title"
          content="How to Build Virtual Machine on ESXi with Windows Worker - Attune Automation" />
    <meta name="twitter:description" content="" />

    <link rel="icon" href="https://www.servertribe.com/wp-content/uploads/2020/10/cropped-server_tribe_favicon-32x32.png" sizes="32x32">
    <link rel="icon" href="https://www.servertribe.com/wp-content/uploads/2020/10/cropped-server_tribe_favicon-192x192.png" sizes="192x192">
    <link rel="apple-touch-icon" href="https://www.servertribe.com/wp-content/uploads/2020/10/cropped-server_tribe_favicon-180x180.png">
    <meta name="msapplication-TileImage" content="https://www.servertribe.com/wp-content/uploads/2020/10/cropped-server_tribe_favicon-270x270.png">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
          crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <link rel="stylesheet" href="styles/style.css">

    <!-- Google tag (gtag.js) -->
    <script async
            src="https://www.googletagmanager.com/gtag/js?id=G-5TZQZNDJCD"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-5TZQZNDJCD');
    </script>
</head>


<body>

<!-- Project NavBar -->

<div class="bg-white border-bottom box-shadow sticky-top mb-3">
<div class="container px-0">
    <div class="row px-0">
        <div class="col d-flex flex-column flex-lg-row align-items-center px-0
            py-3">
            <a class="navbar-brand my-0 mr-lg-auto"
                  href="https://www.servertribe.com/"
                  target="_blank">
                    <img
                        src="https://www.servertribe.com/wp-content/uploads/2022/06/AttuneLogoV2_powered_by.png"
                        alt="Attune - Powered by ServerTribe"
                        class="img-fluid navbar-img">
            </a>
            <nav class="my-2 my-lg-0 mr-lg-3">
                <a class="p-2 text-dark" href="http://doc.servertribe.com/"
                   target="_blank">
                    Documentation
                </a>
                <a class="p-2 text-dark"
                   href="https://discord.com/invite/3YpJsagqUn"
                   target="_blank">
                    Discord
                </a>
                <a class="p-2 text-dark" href="https://github.com/Attune-Automation"
                   target="_blank">
                    GitHub
                </a>
                <a class="p-2 text-dark" href="https://www.servertribe.com/learn/"
                   target="_blank">
                    Learn
                </a>
            </nav>
            <a class="btn btn-outline-primary"
               href="https://www.servertribe.com/download-attune-registration/"
               target="_blank">
                Download NOW!
            </a>
        </div>
    </div>
</div></div>

<!-- Project breadcrumbs -->

<!-- Project breadcrumbs -->
<div class="container px-0">
    <div class="row">
        <nav class="col px-0" aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="index.html">
                    VMWare ESXi APIs
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    <strong>Build Virtual Machine on ESXi with Windows Worker</strong>
                </li>
            </ol>
        </nav>
    </div>
</div>

<!-- Blueprint Header -->

<div class="container px-0">
    <!-- Blueprint name and description -->
    <div class="row">
        <div class="col px-0">
            <h1 class="text-left">
                How to Build Virtual Machine on ESXi with Windows Worker
            </h1>
        </div>
    </div>

<!-- Blueprint Description -->
    <div class="row pt-4">
        <div class="col-6 px-0">
            <h6 class="text-left">
                This documentation is generated by
                <a href="https://www.servertribe.com/"
                    class="badge badge-primary"
                    target="_blank">
                    Attune
                </a>
            </h6>
        </div>
        <div class="col-6 align-self-end text-right px-0">
            <h6 class="text-right">
                <a href="https://www.youtube.com/@servertribe"
                    class="badge badge-secondary"
                    target="_blank">
                    YouTube
                </a>
                <a href="https://github.com/Attune-Automation"
                    class="badge badge-secondary"
                    target="_blank">
                    GitHub
                </a>
                <a href="https://discord.com/invite/3YpJsagqUn"
                    class="badge badge-secondary"
                    target="_blank">
                    Discord
                </a>
                <a href="https://www.linkedin.com/company/servertribe/"
                    class="badge badge-secondary"
                    target="_blank">
                    LinkedIn
                </a>
                <a href="http://doc.servertribe.com/"
                    class="badge badge-secondary"
                    target="_blank">
                    Documentation
                </a>
            </h6>
        </div>
    </div>
    <hr>
</div>

<div class="documentation">
    <div class="container px-0">
        <div class="row">

<!-- Blueprint ToC -->


            <div class="toc col-lg-2 px-0 pr-5">
                <div class="container px-0 pt-3">
                    <p class="pb-2">
                        <strong>Contents</strong>
                    </p>
                    <p class="text-muted">
                        <a href="#top">
                            <strong>Build Virtual Machine on ESXi with Windows Worker</strong>
                        </a>
                    </p>


    
        

                    <p class="text-muted pt-2">
                        <a href="#checkifkickstartisosexistonesxihostwithwindowsworker">
                            <strong>Step 1 -</strong> Check if kickstart_isos Exist on ESXi Host with Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#setpowerclioptionswithwindowsworker">
                            <strong>Step 2 -</strong> Set PowerCLI Options with Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#deletevmwithwindowsworker">
                            <strong>Step 3 -</strong> Delete VM with Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#createvmwithwindowsworker">
                            <strong>Step 4 -</strong> Create VM with Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#configurebootfirmwarewithwindowsworker">
                            <strong>Step 5 -</strong> Configure Boot Firmware with Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#enablesaswithwindowsworker">
                            <strong>Step 6 -</strong> Enable SAS with Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#enable3dwithwindowsworker">
                            <strong>Step 7 -</strong> Enable 3D with Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#setbootorderwithwindowsworker">
                            <strong>Step 8 -</strong> Set Boot Order with Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#setnetworkadaptertovmxnet3">
                            <strong>Step 9 -</strong> Set Network Adapter to vmxnet3
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#copyisotohostwithwindowsworker">
                            <strong>Step 10 -</strong> Copy ISO To Host with Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#copydriversisotoesxihostwithwindowsworker">
                            <strong>Step 11 -</strong> Copy Drivers ISO to ESXi Host with Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#loadosisointovmwithwindowsworker">
                            <strong>Step 12 -</strong> Load OS ISO into VM with Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#loaddriversisointovmwithwindowsworker">
                            <strong>Step 13 -</strong> Load Drivers ISO into VM with Windows Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#startvmwithwindowsworker">
                            <strong>Step 14 -</strong> Start VM with Windows Worker
                        </a>
                    </p>


                </div>
            </div>

<!-- Blueprint Contents -->
            <div class="col-lg-8 pt-3">
                <div class="container">


        <div class="jumbotron">
            <p class="display-3 text-center">
                <strong>Automate This</strong>
            </p>
            <p class="lead text-center">
                Use the <strong>Attune GUI</strong> for your Scripts
            </p>
            <p class="lead">
                <ol>
                    <a href="https://www.servertribe.com/download-attune-registration/"
                        target="_blank">
                        <span class="badge badge-primary">1</span>
                        Download Attune
                        <i class="fa-solid fa-download fa-beat-fade" style="color: #0197ff;"></i>
                    </a>
                </ol>
                <ol>
                    <a href="https://github.com/attune-Automation/"
                        target="_blank">
                        <span class="badge badge-primary">2</span>
                         Copy the Attune Project URL
                         <i class="fa-brands fa-github fa-fade"></i>
                    </a>
                </ol>
                <ol>
                    <a href="https://servertribe-attune.readthedocs.io/en/latest/howto/design_workspace/clone_project.html"
                        target="_blank">
                        <span class="badge badge-primary">3</span>
                        Clone the Project in Attune
                         <i class="fa-solid fa-book fa-fade" style="color: #0197ff;"></i>
                    </a>
                </ol>
                <ol>
                    <a href="https://www.youtube.com/watch?v=GCWDI29rDV0"
                        target="_blank">
                        <span class="badge badge-primary">4</span>
                        Plan your Job(s)
                        <i class="fa-brands fa-youtube fa-fade" style="color: #0197ff;"></i>
                    </a>
                </ol>
                <ol>
                    <a href="https://www.youtube.com/watch?v=b7DhFcURkZg"
                        target="_blank">
                        <span class="badge badge-primary">5</span>
                        Run your Job(s)
                        <i class="fa-brands fa-youtube fa-fade" style="color: #0197ff;"></i>
                    </a>
                </ol>
            </p>
            <p class="lead text-center">
                You've automated: <strong>Build Virtual Machine on ESXi with Windows Worker</strong>
            </p>
            <hr class="my-4 text-center">
            <div class="col px-0">
                <p class="text-center">
                    Get the most out of automation with our get started
                    videos, product demonstrations, and more.
                </p>
                <p class="lead text-center">
                    <a class="btn btn-primary btn-lg"
                       href="https://www.servertribe.com/learn/"
                       target="_blank"
                       role="button">
                        Learn Attune Automation
                    </a>
                </p>
            </div>
        </div>

        <div class="row">
            <p>The following steps will guide you through the manual process.</p>
        </div>

<!-- Blueprint Steps -->


        



                    <div class="row pt-5">
                        <h3 id="checkifkickstartisosexistonesxihostwithwindowsworker">
                            <a href="#checkifkickstartisosexistonesxihostwithwindowsworker">
                                <strong>Step 1 -</strong> Check if kickstart_isos Exist on ESXi Host with Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Checks if the <code>/kickstart_isos</code> directory exists on the ESXi host.</p>
                            </p>
                        </div>
                    </div>










                        <div class="row">
                            <p>
                                Connect via RDP:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
mstsc /admin /v:{automationworkerwindowsnode}
                            </code>
                        </div>
                        <div class="row">
                            <p>
                                Login as user {automationworkerwindowsuseradministrator} and open a
                                command prompt.
                            </p>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$ErrorActionPreference = &quot;Stop&quot;
Import-Module VMware.VimAutomation.Core

Connect-VIServer {vmwareVcenterNode.ip} `
    -User &quot;{vmwareVcenterUser.user}&quot; `
    -Password &#x27;{vmwareVcenterUser.password}&#x27;

if ($? -eq $false) {
    Write-Host &quot;Error: Not connected.&quot;
    exit 1
}

# Get the Datastore
$datastore = Get-Datastore -Name &#x27;{vmStoragePoolName}&#x27;
$datastore

# Create the DS drive
if (Test-Path &quot;ds:&quot;) {
    Remove-PSDrive ds -Force
}

if ($datastore -is [System.Array]) {
    Write-Host &quot;Get-Datastore returned multiple datastores, using first item in array..&quot;
    $datastore = $datastore[0]
}

New-PSDrive -Location $datastore -Name ds -PSProvider VimDatastore -Root &quot;&quot;

$vmwareBootIsoDirectory = &quot;/kickstart_isos&quot;

# Ensure the destination dir exists
$KICKSTART_ISOS_DIR=&quot;ds:$vmwareBootIsoDirectory/&quot;
$KICKSTART_ISOS_DIR = $KICKSTART_ISOS_DIR -Replace &quot;/&quot;,&quot;\&quot;
Write-Host &quot;KICKSTART_ISOS_DIR=$KICKSTART_ISOS_DIR&quot;

Get-Location

if (-Not (Test-Path $KICKSTART_ISOS_DIR)) {
    Write-host &quot;Please create a $vmwareBootIsoDirectory directory on the ESXi Host.&quot;
    exit 1
} else {
    Write-host &quot;$vmwareBootIsoDirectory directory exists on the ESXi Host. Great.&quot;
}

# Remove the DS Drive
Remove-PSDrive ds -Force
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="setpowerclioptionswithwindowsworker">
                            <a href="#setpowerclioptionswithwindowsworker">
                                <strong>Step 2 -</strong> Set PowerCLI Options with Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Sets PowerShell CLI options.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$ErrorActionPreference = &quot;Stop&quot;
Import-Module VMware.VimAutomation.Core
Set-PowerCLIConfiguration -Scope User -ParticipateInCEIP $false -Confirm:$false
Set-PowerCLIConfiguration -InvalidCertificateAction ignore -Confirm:$false
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="deletevmwithwindowsworker">
                            <a href="#deletevmwithwindowsworker">
                                <strong>Step 3 -</strong> Delete VM with Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Deletes a ESXi virtual machine given it's fully qualified domain name or by it's hostname.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$ErrorActionPreference = &quot;Stop&quot;
Import-Module VMware.VimAutomation.Core

Connect-VIServer {vmwareVcenterNode.ip} `
    -User &quot;{vmwareVcenterUser.user}&quot; `
    -Password &quot;{vmwareVcenterUser.password}&quot;

if ($? -eq $false) {
    Write-Host &quot;Error: Not connected.&quot;
    exit 1
}

$exists = Get-VM &quot;{newVmNode.fqn}&quot; -ErrorAction SilentlyContinue
if ( -Not $exists ) {
    &quot;The VM doesn&#x27;t exist&quot;
} else {
    $VM = Get-VM &quot;{newVmNode.fqn}&quot;

    if ( $VM.PowerState -eq &quot;PoweredOn&quot; ) {
        &quot;Stopping the VM&quot;
        Stop-VM -VM $VM -Confirm:$false
    } else {
        &quot;The VM is off&quot;
    }
    
    &quot;Removing the VM&quot;
    Remove-VM -DeleteFromDisk -VM $VM -Confirm:$false
   
}
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="createvmwithwindowsworker">
                            <a href="#createvmwithwindowsworker">
                                <strong>Step 4 -</strong> Create VM with Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>All VMs are kickstarted with a default 50g disk. More disks can be added once the operating system is installed with subsequent "add disk" vCenter calls.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$ErrorActionPreference = &quot;Stop&quot;
Import-Module VMware.VimAutomation.Core

Connect-VIServer {vmwareVcenterNode.ip} `
    -User &quot;{vmwareVcenterUser.user}&quot; `
    -Password &#x27;{vmwareVcenterUser.password}&#x27;

if ($? -eq $false) {
    Write-Host &quot;Error: Not connected.&quot;
    exit 1
}

$name = &quot;{newVmNode.fqn}&quot;
$storagePool = &quot;{vmStoragePoolName}&quot;
$cpuCount = {vmCpuCount}
$memInMb = {vmRamSizeGb}*1024
$networkName = &quot;{vmNetworkName}&quot;
$guestType = &quot;{vmGuestType}&quot;

if ( &quot;{vmwareEsxiHost.fqn}&quot; -eq &quot;{vmwareVcenterNode.fqn}&quot; ) {
    Write-Host &quot;We&#x27;re talking to the ESXi host, don&#x27;t pass the -VMHost arg&quot;
    $vm = New-VM `
        -Name &quot;$name&quot; `
        -Datastore &quot;$storagePool&quot; `
        -CoresPerSocket $cpuCount `
        -NumCpu $cpuCount `
        -DiskMB 51200 `
        -MemoryMB $memInMb `
        -NetworkName &quot;$networkName&quot; `
        -GuestId &quot;$guestType&quot; `
        -CD 

} else {
    Write-Host &quot;We&#x27;re talking to a vCenter server, pass the -VMHost arg&quot;
    $storagePool = Get-VMHost -Name &#x27;{vmwareEsxiHost.fqn}&#x27; | Get-Datastore -Name &#x27;{vmStoragePoolName}&#x27; 
    
    $vm = New-VM `
        -VMHost &quot;{vmwareEsxiHost.fqn}&quot; `
        -Name &quot;$name&quot; `
        -Datastore &quot;$storagePool&quot; `
        -CoresPerSocket $cpuCount `
        -NumCpu $cpuCount `
        -DiskMB 51200 `
        -MemoryMB $memInMb `
        -NetworkName &quot;$networkName&quot; `
        -GuestId &quot;$guestType&quot; `
        -CD 

}
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="configurebootfirmwarewithwindowsworker">
                            <a href="#configurebootfirmwarewithwindowsworker">
                                <strong>Step 5 -</strong> Configure Boot Firmware with Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>https://communities.vmware.com/t5/VMware-PowerCLI-Discussions/Set-Enable-SecureBoot-PowerCLI/td-p/449027</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$ErrorActionPreference = &quot;Stop&quot;
Import-Module VMware.VimAutomation.Core

Connect-VIServer {vmwareVcenterNode.ip} `
    -User &quot;{vmwareVcenterUser.user}&quot; `
    -Password &#x27;{vmwareVcenterUser.password}&#x27;

if ($? -eq $false) {
    Write-Host &quot;Error: Not connected.&quot;
    exit 1
}

$vm = Get-VM -Name &quot;{newVmNode.fqn}&quot;

$spec = New-Object VMware.Vim.VirtualMachineConfigSpec

if (${{virtualMachineBootLoaderIsUefi}}) {
    $spec.Firmware = [VMware.Vim.GuestOsDescriptorFirmwareType]::efi
    
    $boot = New-Object VMware.Vim.VirtualMachineBootOptions
    $boot.EfiSecureBootEnabled = $true
    $spec.BootOptions = $boot
}

if (${{virtualMachineBootLoaderIsBios}}) {
    $spec.Firmware = [VMware.Vim.GuestOsDescriptorFirmwareType]::bios

    $boot = New-Object VMware.Vim.VirtualMachineBootOptions
    $boot.EfiSecureBootEnabled = $false
    $spec.BootOptions = $boot
}

$vm.ExtensionData.ReconfigVM($spec)
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="enablesaswithwindowsworker">
                            <a href="#enablesaswithwindowsworker">
                                <strong>Step 6 -</strong> Enable SAS with Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
if ( &#x27;{vmGuestType}&#x27; -ne &#x27;winNetStandard64Guest&#x27; ) {
    Write-Host &quot;This isn&#x27;t windows server VM, SAS not required&quot;
} else {
    Write-Host &quot;Switching to LSI Logic SAS Controller&quot;

    $ErrorActionPreference = &quot;Stop&quot;
    Import-Module VMware.VimAutomation.Core
    
    Connect-VIServer {vmwareVcenterNode.ip} `
        -User {vmwareVcenterUser.user} `
        -Password {vmwareVcenterUser.password}
    
    if ($? -eq $false) {
        Write-Host &quot;Error: Not connected.&quot;
        exit 1
    }
     
    $vm = Get-VM -Name &quot;{newVmNode.fqn}&quot;
     
    # Make the controller compatible with the Win2016 drivers
    Get-ScsiController -VM $vm | Set-ScsiController -Type VirtualLsiLogicSAS

}
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="enable3dwithwindowsworker">
                            <a href="#enable3dwithwindowsworker">
                                <strong>Step 7 -</strong> Enable 3D with Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Enables 3D support if target build is Windows Desktop 10.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
if ( &#x27;{vmGuestType}&#x27; -ne &#x27;windows9_64Guest&#x27; ) {
    Write-Host &quot;This isn&#x27;t windows 10, 3D isn&#x27;t required&quot;
} else {
    Write-Host &quot;Enabling 3D&quot;

    $ErrorActionPreference = &quot;Stop&quot;
    Import-Module VMware.VimAutomation.Core
    
    Connect-VIServer {vmwareVcenterNode.ip} `
        -User &quot;{vmwareVcenterUser.user}&quot; `
        -Password &#x27;{vmwareVcenterUser.password}&#x27;
    
    if ($? -eq $false) {
        Write-Host &quot;Error: Not connected.&quot;
        exit 1
    }
    
    $vm = Get-View -ViewType VirtualMachine -Filter @{&#x27;Name&#x27;=&quot;^{newVmNode.fqn}$&quot;}
     
    $spec = New-Object VMware.Vim.VirtualMachineConfigSpec
    $dc = New-Object VMware.Vim.VirtualDeviceConfigSpec
    $dc.Operation = &#x27;edit&#x27;
    $dev = $vm.Config.Hardware.Device | where{$_ -is [VMware.Vim.VirtualMachineVideoCard]}
    $dev.enable3DSupport = $true
    $dc.Device += $dev
    $spec.DeviceChange += $dc
    $vm.ReconfigVM($spec)

}
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="setbootorderwithwindowsworker">
                            <a href="#setbootorderwithwindowsworker">
                                <strong>Step 8 -</strong> Set Boot Order with Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Sets the boot order to be hard disk, then CD-ROM.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
if (${{virtualMachineBootLoaderIsBios}}) {

  $ErrorActionPreference = &quot;Stop&quot;
  Import-Module VMware.VimAutomation.Core

  Connect-VIServer {vmwareVcenterNode.ip} `
      -User {vmwareVcenterUser.user} `
      -Password {vmwareVcenterUser.password}

  if ($? -eq $false) {
      Write-Host &quot;Error: Not connected.&quot;
      exit 1
  }

  $vm = Get-VM -Name &quot;{newVmNode.fqn}&quot;

  # the device name of the hard disk to which to boot
  $strBootHDiskDeviceName = &quot;Hard disk 1&quot;

  # get the VirtualDisk device, then grab its Key (DeviceKey, used later)
  $intHDiskDeviceKey = ($vm.ExtensionData.Config.Hardware.Device | ?{$_.DeviceInfo.Label -eq $strBootHDiskDeviceName}).Key

  # bootable Disk BootOption device, for use in setting BootOrder (the corresponding VirtualDisk device is bootable, assumed)
  $oBootableHDisk = New-Object -TypeName VMware.Vim.VirtualMachineBootOptionsBootableDiskDevice -Property @{&quot;DeviceKey&quot; = $intHDiskDeviceKey}

  # bootable CDROM device (per the docs, the first CDROM with bootable media found is used)
  $oBootableCDRom = New-Object -Type VMware.Vim.VirtualMachineBootOptionsBootableCdromDevice

  $spec = New-Object VMware.Vim.VirtualMachineConfigSpec -Property @{
      &quot;BootOptions&quot; = New-Object VMware.Vim.VirtualMachineBootOptions -Property @{
          BootOrder = $oBootableHDisk, $oBootableCDRom
      } # end new-object
  } # end new-object

  # reconfig the VM to use the spec with the new BootOrder
  $vm.ExtensionData.ReconfigVM_Task($spec)

} else {
    echo &quot;Skipping for UEFI boot.&quot;
}
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="setnetworkadaptertovmxnet3">
                            <a href="#setnetworkadaptertovmxnet3">
                                <strong>Step 9 -</strong> Set Network Adapter to vmxnet3
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Sets the ESXi network adapter type to vmxnet3 for the target Windows virtual machine.</p>
<p>Documentation for <code>Set-NetworkAdapter</code> is at
https://developer.vmware.com/docs/powercli/latest/vmware.vimautomation.core/commands/set-networkadapter/#Default</p>
<p>Pass in the <code>-Confirm:$false</code> option to <code>Set-NetworkAdapter</code> to disable it prompting for user confirmation.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$ErrorActionPreference = &quot;Stop&quot;
Import-Module VMware.VimAutomation.Core

Connect-VIServer {vmwareVcenterNode.ip} `
    -User {vmwareVcenterUser.user} `
    -Password {vmwareVcenterUser.password}

if ($? -eq $false) {
    Write-Host &quot;Error: Not connected.&quot;
    exit 1
}

Write-Host &quot;newVmNode.fqn = {newVmNode.fqn}&quot;

$NETWORK_ADAPTER = (Get-VM -name {newVmNode.fqn} `
    | Get-NetworkAdapter `
    | Where { $_.Type -eq &quot;E1000E&quot;})
    
$NAME = $NETWORK_ADAPTER.name
$ID = $NETWORK_ADAPTER.id
Write-Host &quot;NETWORK_ADAPTER.name = $NAME, id=$ID&quot;

Set-NetworkAdapter -NetworkAdapter ${NETWORK_ADAPTER} `
    -Type &quot;vmxnet3&quot; `
    -Confirm:$false
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="copyisotohostwithwindowsworker">
                            <a href="#copyisotohostwithwindowsworker">
                                <strong>Step 10 -</strong> Copy ISO To Host with Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
# Create the new VM
$ErrorActionPreference = &quot;Stop&quot;
Import-Module VMware.VimAutomation.Core

Connect-VIServer {vmwareVcenterNode.ip} `
    -User &quot;{vmwareVcenterUser.user}&quot; `
    -Password &#x27;{vmwareVcenterUser.password}&#x27;
    
if ($? -eq $false) {
    Write-Host &quot;Error: Not connected.&quot;
    exit 1
}

$vmwareBootIsoDirectory = &quot;/kickstart_isos&quot;

# Create the TO dir string
$to = &quot;ds:$vmwareBootIsoDirectory&quot;
$to = $to -Replace &quot;/&quot;,&quot;\&quot;

# Get the Datastore
$datastore = Get-Datastore -Name &#x27;{vmStoragePoolName}&#x27;
$datastore

# Create the DS drive
if (Test-Path &quot;ds:&quot;) {
    Remove-PSDrive ds -Force
}

if ($datastore -is [System.Array]) {
    Write-Host &quot;Get-Datastore returned multiple datastores, using first item in array..&quot;
    $datastore = $datastore[0]

}
New-PSDrive -Location $datastore -Name ds -PSProvider VimDatastore -Root &quot;&quot;

# Ensure the destination dir exists
Set-Location &quot;ds:&quot;

if (-Not (Test-Path &quot;$to&quot;)) {
    &quot;Creating $to&quot;
    New-Item  -ItemType Directory -Path &quot;$to&quot;
}

# Set the local path to the ISO
Set-Location C:\attuneautomationworker

# Copy the ISO
Copy-DatastoreItem kickstart_{newVmNode.fqn}.iso $to `
    -Force:$true -Confirm:$false 
    
if ($? -eq $false) {
    Write-Host &quot;Error: Copy-DatastoreItem&quot;
    exit 1
}

# Remove the DS Drive
Remove-PSDrive ds -Force
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="copydriversisotoesxihostwithwindowsworker">
                            <a href="#copydriversisotoesxihostwithwindowsworker">
                                <strong>Step 11 -</strong> Copy Drivers ISO to ESXi Host with Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Uploads the ESXi Drivers ISO to ESXi datastore specified in KS VMWare: Storage Pool Name.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
Set-Location &quot;C:\attuneautomationworker&quot;
if ( -Not (Test-Path &quot;drivers_{newVmNode.fqn}.iso&quot; `
    -PathType Leaf) ) {
    Write-Host &quot;This build doesn&#x27;t have a C:\attuneautomationworker\drivers_{newVmNode.fqn}.iso.&quot;
} else {

    $ErrorActionPreference = &quot;Stop&quot;
    Import-Module VMware.VimAutomation.Core
    
    Connect-VIServer {vmwareVcenterNode.ip} `
        -User {vmwareVcenterUser.user} `
        -Password {vmwareVcenterUser.password}
        
    if ($? -eq $false) {
        Write-Host &quot;Error: Not connected.&quot;
        exit 1
    }
    
    $vmwareBootIsoDirectory = &quot;/kickstart_isos&quot;

    # Create the TO dir string
    $to = &quot;ds:$vmwareBootIsoDirectory&quot;
    $to = $to -Replace &quot;/&quot;,&quot;\&quot;
    
    # Get the Datastore
    $datastore = Get-Datastore -Name &#x27;{vmStoragePoolName}&#x27;
    $datastore
    
    # Create the DS drive
    if (Test-Path &quot;ds:&quot;) {
        Remove-PSDrive ds -Force
    }
    
    if ($datastore -is [System.Array]) {
        Write-Host &quot;Get-Datastore returned multiple datastores, using first item in array..&quot;
        $datastore = $datastore[0]
    
    }
    
    New-PSDrive -Location $datastore -Name ds -PSProvider VimDatastore -Root &quot;&quot;
    
    # Ensure the destination dir exists
    Set-Location &quot;ds:&quot;
    
    if (-Not (Test-Path &quot;$to&quot;)) {
        &quot;Creating $to&quot;
        New-Item  -ItemType Directory -Path &quot;$to&quot;
    }
    
    # Set the local path to the ISO
    Set-Location C:\attuneautomationworker
    
    # Copy the ISO
    Copy-DatastoreItem drivers_{newVmNode.fqn}.iso $to `
        -Force:$true -Confirm:$false 
    
        
    # Remove the DS Drive
    Remove-PSDrive ds -Force
    
}
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="loadosisointovmwithwindowsworker">
                            <a href="#loadosisointovmwithwindowsworker">
                                <strong>Step 12 -</strong> Load OS ISO into VM with Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Loads the WinPE ISO into the target Windows virtual machine's CD-ROM.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$ErrorActionPreference = &quot;Stop&quot;
Import-Module VMware.VimAutomation.Core

Connect-VIServer {vmwareVcenterNode.ip} `
    -User &quot;{vmwareVcenterUser.user}&quot; `
    -Password &#x27;{vmwareVcenterUser.password}&#x27;

if ($? -eq $false) {
    Write-Host &quot;Error: Not connected.&quot;
    exit 1
}

$vmwareBootIsoDirectory = &quot;/kickstart_isos&quot;

$cd = Get-VM -Name &quot;{newVmNode.fqn}&quot; | Get-CDDrive
$iso = &quot;[{vmStoragePoolName}] $vmwareBootIsoDirectory/kickstart_{newVmNode.fqn}.iso&quot;

Set-CDDrive -CD $cd `
    -IsoPath $iso `
    -StartConnected $true `
    -Confirm:$false
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="loaddriversisointovmwithwindowsworker">
                            <a href="#loaddriversisointovmwithwindowsworker">
                                <strong>Step 13 -</strong> Load Drivers ISO into VM with Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Uploads the ESXi Drivers ISO to ESXi datastore specified in KS VMWare: Storage Pool Name.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
Set-Location C:\attuneautomationworker
if ( -Not (Test-Path &quot;drivers_{newVmNode.fqn}.iso&quot; `
    -PathType Leaf) ) {
    Write-Host &quot;This build doesn&#x27;t have a C:\attuneautomationworker\drivers_{newVmNode.fqn}.iso.&quot;
} else {
        
    $ErrorActionPreference = &quot;Stop&quot;
    Import-Module VMware.VimAutomation.Core
    
    Connect-VIServer {vmwareVcenterNode.ip} `
        -User {vmwareVcenterUser.user} `
        -Password {vmwareVcenterUser.password}
    
    if ($? -eq $false) {
        Write-Host &quot;Error: Not connected.&quot;
        exit 1
    }
    
    $vm = Get-VM -Name &quot;{newVmNode.fqn}&quot;
    $vmwareBootIsoDirectory = &quot;/kickstart_isos&quot;
    
    $iso = &quot;[{vmStoragePoolName}] $vmwareBootIsoDirectory/drivers_{newVmNode.fqn}.iso&quot;
    
    New-CDDrive -VM $vm -IsoPath $iso -StartConnected
    
}
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="startvmwithwindowsworker">
                            <a href="#startvmwithwindowsworker">
                                <strong>Step 14 -</strong> Start VM with Windows Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Boot the target Windows virtual machine up. It will kickstart from the CD-ROM.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
$ErrorActionPreference = &quot;Stop&quot;
Import-Module VMware.VimAutomation.Core

Connect-VIServer {vmwareVcenterNode.ip} `
    -User &quot;{vmwareVcenterUser.user}&quot; `
    -Password &#x27;{vmwareVcenterUser.password}&#x27;

if ($? -eq $false) {
    Write-Host &quot;Error: Not connected.&quot;
    exit 1
}

Start-VM -VM (Get-VM -Name &quot;{newVmNode.fqn}&quot;) -RunAsync
                </code>
            </pre>
        </div>
    </div>






                    <div class="row pt-5">
                        <div class="col">
                            <h2>Completed</h2>
                            <p>
                                You have completed this instruction.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

<!-- Download Attune Ad -->

            <div class="toc col-lg-2 px-0">
                <div class="container px-0 pt-3 pl-5">
                    <div class="card border-light mb-3" style="max-width: 18rem;">
                        <div class="card-body attune-ad">
                            <img
                                src="https://www.servertribe.com/wp-content/uploads/2022/06/AttuneLogoV2_powered_by.png"
                                alt="Attune - Powered by ServerTribe"
                                class="img-fluid">
                            <p class="card-title mt-3 text-center">
                                <strong>Automate with Attune</strong>
                            </p>
                            <p class="card-text text-center">
                                Download the Attune Community Edition.
                            </p>
                            <p class="text-center">
                                <a href="https://www.servertribe.com/download-attune-registration/"
                                   class="btn btn-primary mt-3">
                                    DOWNLOAD!!!
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

<!-- Join Discord -->

        <div class="row py-5">
            <div class="jumbotron">
              <h1 class="display-4 text-center">
                  Discuss this Project in Discord
              </h1>
              <p class="lead">

                  Join our Discord channel and connect with like-minded individuals who
                  share your passion. Engage in lively discussions, gain valuable insights,
                  and stay updated on the latest trends in our industry. Don't miss out on
                  this opportunity to network, learn, and grow together.
              </p>
              <hr class="my-4 text-center">
                <div class="col px-0">
                  <p class="text-center">
                      Click the link below and become a part of our vibrant community on
                      Discord today!
                  </p>
                  <p class="lead text-center">
                    <a class="btn btn-primary btn-lg"
                       href="https://discord.com/invite/3YpJsagqUn"
                       role="button">
                        Join NOW!!!
                    </a>
                  </p>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Project Footer -->

<footer class="footer fixed-bottom bg-white border-top box-shadow">
      <div class="container px-0">
          <div class="row">
              <div class="col px-0">
                  <a class="my-0 mr-lg-auto"
                     href="https://www.servertribe.com/"
                     target="_blank">
                      <img
                          src="https://www.servertribe.com/wp-content/uploads/2022/06/AttuneLogoV2_powered_by.png"
                          alt="Attune - Powered by ServerTribe"
                          class="img-fluid navbar-img">
                  </a>
              </div>
          </div>
      </div>
</footer>


<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
<script
    src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>

<script
    src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<script
    src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script
    src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>


</body>
</html>
